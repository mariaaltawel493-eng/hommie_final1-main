import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:hommie/app/utils/app_colors.dart';
import 'package:hommie/data/models/apartment/owner_apartment_model.dart';
import 'package:hommie/data/models/user/user_permission_controller.dart';
import 'package:hommie/data/repositories/apartment_repository.dart';
import 'package:image_picker/image_picker.dart';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPDATED POST AD CONTROLLER
// With Approval System and Image Handling
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class PostAdController extends GetxController {
  final ApartmentRepository repo;
  PostAdController(this.repo);

  // ADD THIS: Get permissions controller
  final permissions = Get.find<UserPermissionsController>();

  List<OwnerApartmentModel> get myApartments => repo.apartments;

  OwnerApartmentModel? draft;

  Future<void> load() async => repo.load();

  void startNewDraft() {
    print('');
    print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    print('ğŸ“ STARTING NEW DRAFT');
    print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    draft = OwnerApartmentModel(
      id: UniqueKey().toString(),
      title: "",
      description: "",
      governorate: "",
      city: "",
      address: "",
      pricePerDay: 0,
      roomsCount: 1,
      apartmentSize: 0,
      images: [],
      mainImage: null,
    );
    
    print('âœ… New draft created');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SAVE BASIC INFO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Future<void> saveDraftBasicInfo({
    required String title,
    required String description,
    required String governorate,
    required String city,
    required String address,
    required double pricePerDay,
    required int roomsCount,
    required double apartmentSize,
  }) async {
    if (draft == null) startNewDraft();
    
    print('');
    print('ğŸ“‹ Saving basic info:');
    print('   Title: $title');
    print('   Governorate: $governorate');
    print('   City: $city');
    print('   Price: \$$pricePerDay/day');
    print('   Rooms: $roomsCount');
    print('   Size: ${apartmentSize}mÂ²');
    
    draft!
      ..title = title
      ..description = description
      ..governorate = governorate
      ..city = city
      ..address = address
      ..pricePerDay = pricePerDay
      ..roomsCount = roomsCount
      ..apartmentSize = apartmentSize;
      
    print('âœ… Basic info saved to draft');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SAVE IMAGES FROM URLs
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Future<void> saveDraftImages({
    required List<String> images,
    required String mainImage,
  }) async {
    if (draft == null) return;
    
    print('');
    print('ğŸ–¼ï¸  Saving image URLs:');
    print('   Images count: ${images.length}');
    print('   Main image: $mainImage');
    
    draft!
      ..images = images
      ..mainImage = mainImage;
      
    print('âœ… Images saved to draft');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SAVE IMAGES FROM FILES (UPDATED IMPLEMENTATION)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Future<void> saveDraftImagesFromFiles({
    required List<XFile> imageFiles,
    XFile? mainImageFile,
  }) async {
    if (draft == null) {
      print('âš ï¸  No draft found, creating new one');
      startNewDraft();
    }

    print('');
    print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    print('ğŸ“¸ SAVING IMAGES FROM FILES');
    print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    print('   Total images: ${imageFiles.length}');
    print('   Main image: ${mainImageFile != null ? "Yes" : "No"}');

    // Convert XFile paths to image URLs/paths for storage
    List<String> imagePaths = imageFiles.map((file) => file.path).toList();
    String? mainImagePath = mainImageFile?.path;

    draft!
      ..images = imagePaths
      ..mainImage = mainImagePath ?? (imagePaths.isNotEmpty ? imagePaths.first : null);

    print('âœ… Images saved:');
    print('   Images: ${imagePaths.length} files');
    print('   Main image: ${draft!.mainImage}');
    print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PUBLISH DRAFT (WITH PERMISSION CHECK)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Future<void> publishDraft() async {
    if (draft == null) {
      print('âš ï¸  No draft to publish');
      return;
    }

    print('');
    print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    print('ğŸš€ PUBLISHING DRAFT');
    print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    print('   Title: ${draft!.title}');
    print('   Price: \$${draft!.pricePerDay}/day');
    print('   Location: ${draft!.governorate}, ${draft!.city}');
    print('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');

    // CHECK PERMISSION FIRST
    if (!permissions.checkPermission('post', showMessage: true)) {
      print('âŒ Publish denied - User not approved');
      print('   Is Approved: ${permissions.isApproved.value}');
      print('   Role: ${permissions.userRole.value}');
      print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      return;
    }

    print('âœ… Permission granted - Publishing apartment');

    try {
      await repo.add(draft!);
      
      print('âœ… APARTMENT PUBLISHED SUCCESSFULLY');
      print('   Apartment ID: ${draft!.id}');
      print('   Total apartments: ${myApartments.length}');
      print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      
      draft = null;
      
      Get.snackbar(
        'âœ… Ù†Ø¬Ø­ Ø§Ù„Ù†Ø´Ø±',
        'ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø´Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­',
        backgroundColor: Colors.green,
        colorText: Colors.white,
        icon: const Icon(Icons.check_circle, color: Colors.white),
      );
      
    } catch (e) {
      print('âŒ PUBLISH FAILED');
      print('   Error: $e');
      print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      
      Get.snackbar(
        'âŒ Ø®Ø·Ø£',
        'ÙØ´Ù„ Ù†Ø´Ø± Ø§Ù„Ø´Ù‚Ø©: $e',
        backgroundColor: AppColors.failure,
        colorText: AppColors.backgroundLight,
      );
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DELETE APARTMENT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Future<void> deleteApartment(String id) async {
    print('');
    print('ğŸ—‘ï¸  Deleting apartment: $id');
    
    await repo.remove(id);
    
    print('âœ… Apartment deleted');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // UPDATE APARTMENT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Future<void> updateApartment(OwnerApartmentModel apt) async {
    print('');
    print('ğŸ“ Updating apartment: ${apt.title}');
    
    await repo.edit(apt);
    
    print('âœ… Apartment updated');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // NAVIGATION HELPER WITH PERMISSION CHECK
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  void onAddApartmentPressed() {
    print('');
    print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    print('â• ADD APARTMENT BUTTON PRESSED');
    print('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');

    // CHECK PERMISSION FIRST
    if (!permissions.checkPermission('post', showMessage: true)) {
      print('âŒ Add apartment denied - User not approved');
      print('   Is Approved: ${permissions.isApproved.value}');
      print('   Role: ${permissions.userRole.value}');
      print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      return;
    }

    print('âœ… Permission granted - Opening apartment form');
    print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    startNewDraft();
    
    // Navigate to add apartment form
    // Get.to(() => ApartmentFormView(isEdit: false));
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // GETTER FOR UI
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  bool get canAddApartment => permissions.canPostApartments;
}